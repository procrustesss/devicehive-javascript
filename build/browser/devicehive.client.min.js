!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.DHClient=t()}(this,function(){var e=function(){"use strict";var e={guid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})},isFunction:function(e){return e&&"[object Function]"===Object.prototype.toString.call(e)},isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isArrayLike:function(e){return e&&e.length>=0&&e.length===Math.floor(e.length)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isAccessKey:function(e){return 44===e.length&&new RegExp("[A-Za-z0-9+/=]").test(e)},inArray:function(t,n,r){if(n){if(!e.isArrayLike(n))throw new TypeError("utils.inArray second argument must be an array");if(Array.prototype.indexOf&&e.isArray(n))return n.indexOf(t,r);var i=n.length,s=+r||0;if(!i||s>=i)return-1;for(s=0>s?Math.max(0,i+s):s;i>s;s++)if(s in n&&n[s]===t)return s;return-1}},map:function(t,n){if(!t)return t;if(!e.isFunction(n))throw new TypeError(callback+" is not a function");var r=[];return e.forEach(t,function(e){r.push(n.call(this,e,t))}),r},reduce:function(t,n){if(!t)return t;if(!e.isFunction(n))throw new TypeError(n+" is not a function");var r,i=t,s=i.length>>>0,a=0;if(3==arguments.length)r=arguments[2];else{for(;s>a&&!a in i;)a++;if(a>=s)throw new TypeError("Reduce of empty array with no initial value");r=i[a++]}for(;s>a;a++)a in i&&(r=n(r,i[a],a,i));return r},forEach:function(t,n){if(!t)return t;if(!e.isFunction(n))throw new TypeError(n+" is not a function");var r;if(e.isArrayLike(t)){var i=t.length;for(r=0;i>r&&n.call(t[r],r,t)!==!1;r++);}else for(r in t)if(t.hasOwnProperty(r)&&n.call(t[r],r,t)===!1)break;return t},filter:function(t,n){if(!t)return t;if(!e.isFunction(n))throw new TypeError(n+" is not a function");var r=[];return e.forEach(t,function(e){n.call(this,e,t)&&r.push(this)}),r},toArray:function(t){return e.filter(t,function(){return!0})},find:function(t,n){var r=e.filter(t,n);return r&&r.length>0?r[0]:null},parseDate:function(e){return new Date(e.substring(0,4),parseInt(e.substring(5,7),10)-1,e.substring(8,10),e.substring(11,13),e.substring(14,16),e.substring(17,19),e.substring(20,23))},formatDate:function(t){if(e.isString(t))return t;if("[object Date]"!==Object.prototype.toString.call(t))throw new Error("Invalid object type");var n=function(e,t){for(e=String(e),t=t||2;e.length<t;)e="0"+e;return e};return t.getUTCFullYear()+"-"+n(t.getUTCMonth()+1)+"-"+n(t.getUTCDate())+"T"+n(t.getUTCHours())+":"+n(t.getUTCMinutes())+":"+n(t.getUTCSeconds())+"."+n(t.getUTCMilliseconds(),3)},encodeBase64:function(e){var t,n,r,i,s,a,o,u,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,h=0,d="",f=[];if(!e)return e;do t=e.charCodeAt(l++),n=e.charCodeAt(l++),r=e.charCodeAt(l++),u=t<<16|n<<8|r,i=u>>18&63,s=u>>12&63,a=u>>6&63,o=63&u,f[h++]=c.charAt(i)+c.charAt(s)+c.charAt(a)+c.charAt(o);while(l<e.length);d=f.join("");var p=e.length%3;return(p?d.slice(0,p-3):d)+"===".slice(p||3)},noop:function(){},createCallback:function(t){return e.isFunction(t)?t:e.noop},serializeQuery:function(e){var t,n,r="";for(t in e)e.hasOwnProperty(t)&&(""!==r&&(r+="&"),n=e[t],n=null===n?"":n,r+=encodeURIComponent(t)+"="+encodeURIComponent(n));return r},isHttpRequestSuccessfull:function(e){return e&&e>=200&&300>e||304===e},isRequestWithBody:function(e){return"POST"==e||"PUT"==e},makeUrl:function(t){var n=t.method,r=t.url,i=t.data;return"GET"===n&&i&&(i=e.serializeQuery(i),i&&(r+=(-1!=r.indexOf("?")?"&":"?")+i)),r},errorMessage:function(e){return{error:"DeviceHive error: "+e}},serverErrorMessage:function(e,t){var n=e&&t&&(t.message||t.Message);return n+=t&&t.ExceptionMessage&&" "+t.ExceptionMessage,"DeviceHive server error"+(n&&" - "+n)},setTimeout:function(e,t){return setTimeout(e,t)},clearTimeout:function(e){clearTimeout(e)}};return e}(),t=function(){"use strict";var t=function(){};return t.prototype={bind:function(e,t,n){this._handlers||(this._handlers={});var r=this._handlers[e]||(this._handlers[e]=[]);r.push({callback:t,context:n||this});var i=this;return{unbind:function(){i.unbind(e,t)}}},unbind:function(t,n){if(!t&&!n)return this._handlers=null,this;var r=this._handlers[t];if(!r)return this;if(!n)return delete this._handlers[t],this;var i=[];return e.forEach(r,function(){var e=this;n&&n!==e.callback&&i.push(e)}),i.length?this._handlers[t]=i:delete this._handlers[t],this},trigger:function(t){if(!this._handlers)return this;var n=e.toArray(arguments).slice(1),r=this._handlers[t];return r&&this._triggerEvents(r,n),this},_triggerEvents:function(t,n){e.forEach(t,function(){var e=this;e.callback.apply(e.context,n)})}},t}(),n=function(){"use strict";var t=e.noop();if(t="undefined"!=typeof XMLHttpRequest?function(){return new XMLHttpRequest}:function(){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){return null}},!t())throw new Error("DeviceHive: XMLHttpRequest is not available");return{send:function(n,r){n.method=n.method||"GET",r=e.createCallback(r);var i=t(),s=n.headers,a=e.makeUrl(n),o=n.method;return i.open(o,a,!0),("POST"==o||"PUT"==o)&&(i.setRequestHeader("Content-Type","application/json"),n.data=JSON.stringify(n.data)),i.onreadystatechange=function(){if(4===i.readyState){var t=e.isHttpRequestSuccessfull(i.status),n=i.responseText&&JSON.parse(i.responseText);if(t)return r(null,n);var s=e.serverErrorMessage(i.responseText,n),a={error:s,request:i};return r(a)}},s&&e.forEach(s,function(e){i.setRequestHeader(e,this)}),i.send(n.data||void 0),{abort:function(){i.abort()}}}}}(),r=function(){"use strict";var t={USER:1,KEY:2,DEVICE:4},r=function(e,t){return(e&t)==t},i=function(n,i){var s=i.authTypes,a=i.auth;if(n.headers=i.headers||{},s){if(!a)throw new Error("Authentication parameters must be specified for this endpoint. Endpoint auth code: "+s);if(r(s,t.KEY)&&a.accessKey)n.headers.Authorization="Bearer "+a.accessKey;else if(r(s,t.DEVICE)&&a.deviceId&&a.deviceKey)n.headers["Auth-DeviceID"]=a.deviceId,n.headers["Auth-DeviceKey"]=a.deviceKey;else{if(!r(s,t.USER))throw new Error("Invalid authentication parameters. Endpoint auth code: "+s);n.headers.Authorization="Basic "+e.encodeBase64(a.login+":"+a.password)}}},s=function(e,t){var r={method:e.method,url:e.base+e.relative,data:e.data};return i(r,e),n.send(r,t)};return{info:function(e,t){return s({base:e,relative:"/info",method:"GET"},t)},getAccessKeys:function(e,n,r,i){return s({base:e,relative:"/user/"+r+"/accesskey",method:"GET",authTypes:t.USER,auth:n},i)},getAccessKey:function(e,n,r,i,a){return s({base:e,relative:"/user/"+r+"/accesskey/"+r,method:"GET",authTypes:t.USER,auth:n},a)},insertAccessKey:function(e,n,r,i,a){return s({base:e,relative:"/user/"+r+"/accesskey",data:i,method:"POST",authTypes:t.USER,auth:n},a)},updateAccessKey:function(e,n,r,i,a,o){return s({base:e,relative:"/user/"+r+"/accesskey/"+i,data:a,method:"PUT",authTypes:t.USER,auth:n},o)},deleteAccessKey:function(e,n,r,i,a){return s({base:e,relative:"/user/"+r+"/accesskey/"+i,method:"DELETE",authTypes:t.USER,auth:n},a)},getDevices:function(e,n,r,i){return s({base:e,relative:"/device",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},getDevice:function(e,n,r,i){return s({base:e,relative:"/device/"+r,method:"GET",authTypes:t.USER|t.KEY|t.DEVICE,auth:n},i)},getEquipmentState:function(e,n,r,i){return s({base:e,relative:"/device/"+r+"/equipment",method:"GET",authTypes:t.USER|t.KEY,auth:n},i)},registerDevice:function(e,n,r,i,a){return s({base:e,relative:"/device/"+r,method:"PUT",data:i,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},a)},getDeviceClass:function(e,n,r,i){return s({base:e,relative:"/device/class/"+r,method:"GET",authTypes:t.USER,auth:n},i)},getCommands:function(n,r,i,a,o){return a&&a.start&&(a.start=e.formatDate(a.start)),a&&a.end&&(a.end=e.formatDate(a.end)),s({base:n,relative:"/device/"+i+"/command",method:"GET",data:a,authTypes:t.USER|t.KEY|t.DEVICE,auth:r},o)},getCommand:function(e,n,r,i,a){return s({base:e,relative:"/device/"+r+"/command/"+i,method:"GET",authTypes:t.USER|t.KEY|t.DEVICE,auth:n},a)},insertCommand:function(e,n,r,i,a){return s({base:e,relative:"/device/"+r+"/command",method:"POST",data:i,authTypes:t.USER|t.KEY,auth:n},a)},updateCommand:function(e,n,r,i,a,o){return s({base:e,relative:"/device/"+r+"/command/"+i,method:"PUT",data:a,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},o)},pollCommands:function(e,n,r,i,a){return s({base:e,relative:"/device/"+r+"/command/poll",method:"GET",data:i,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},a)},pollManyCommands:function(e,n,r,i){return s({base:e,relative:"/device/command/poll",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},waitCommandResult:function(e,n,r,i,a,o){return s({base:e,relative:"/device/"+r+"/command/"+i+"/poll",method:"GET",data:a,authTypes:t.USER|t.KEY,auth:n},o)},getNotifications:function(n,r,i,a,o){return a&&a.start&&(a.start=e.formatDate(a.start)),a&&a.end&&(a.end=e.formatDate(a.end)),s({base:n,relative:"/device/"+i+"/notification",method:"GET",data:a,authTypes:t.USER|t.KEY,auth:r},o)},getNotification:function(e,n,r,i,a){return s({base:e,relative:"/device/"+r+"/notification/"+i,method:"GET",authTypes:t.USER|t.KEY,auth:n},a)},insertNotification:function(e,n,r,i,a){return s({base:e,relative:"/device/"+r+"/notification",method:"POST",data:i,authTypes:t.USER|t.KEY|t.DEVICE,auth:n},a)},pollNotifications:function(e,n,r,i,a){return s({base:e,relative:"/device/"+r+"/notification/poll",method:"GET",data:i,authTypes:t.USER|t.KEY,auth:n},a)},pollManyNotifications:function(e,n,r,i){return s({base:e,relative:"/device/notification/poll",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},getNetworks:function(e,n,r,i){return s({base:e,relative:"/network",method:"GET",data:r,authTypes:t.USER|t.KEY,auth:n},i)},getNetwork:function(e,n,r,i){return s({base:e,relative:"/network/"+r,method:"GET",authTypes:t.USER|t.KEY,auth:n},i)},insertNetwork:function(e,n,r,i){return s({base:e,relative:"/network",method:"POST",data:r,authTypes:t.USER,auth:n},i)},updateNetwork:function(e,n,r,i,a){return s({base:e,relative:"/network/"+r,method:"PUT",data:i,authTypes:t.USER,auth:n},a)},deleteNetwork:function(e,n,r,i){return s({base:e,relative:"/network/"+r,method:"DELETE",authTypes:t.USER,auth:n},i)},getCurrentUser:function(e,n,r){return s({base:e,relative:"/user/current",method:"GET",authTypes:t.USER,auth:n},r)},updateCurrentUser:function(e,n,r,i){return s({base:e,relative:"/user/current",method:"PUT",data:r,authTypes:t.USER,auth:n},i)}}}(),i=function(){"use strict";var n=function(e,n,r){return r=r||e.channelState,r===e.channelState?(e.channelState=n,e._events=e._events||new t,e._events.trigger("onChannelStateChanged",{oldState:r,newState:n}),!0):!1},i=function(t,n){return e.find(t.subscriptions,function(){return this.id===n})},a=function(e,t){var n=e.subscriptions.indexOf(t);e.subscriptions.splice(n,1),t._changeState(s.states.unsubscribed)},o={disconnected:0,connecting:1,connected:2},u=function(){this.channelState=o.disconnected,this._events=new t};return u.prototype={channelStates:o,openChannel:function(t,i){function s(r){a.serverInfo=r,i?e.isArray(i)||(i=[i]):(i=[],e.forEach(a._channels,function(e){i.push(e)}));var s=!0;!function o(r){e.forEach(r,function(i){var u=this;return a._channels[u]?(a.channel=new a._channels[u](a),a.channel.open(function(s){if(s){var c=r.slice(++i);if(!c.length)return t(e.errorMessage("Cannot open any of the specified channels"));o(c)}else n(a,a.channelStates.connected),t(null,u)}),s=!1):void 0})}(i),s&&t(e.errorMessage("None of the specified channels are supported"))}if(t=e.createCallback(t),!n(this,this.channelStates.connecting,this.channelStates.disconnected))return void t(null);var a=this;this.serverInfo?s(this.serverInfo):r.info(this.serviceUrl,function(e,r){e?(n(a,a.channelStates.disconnected),t(e,r)):s(r)})},closeChannel:function(t){if(t=e.createCallback(t),this.channelState===this.channelStates.disconnected)return t(null);var r=this;this.channel&&this.channel.close(function(i,s){return i?t(i,s):(e.forEach(e.toArray(r.channel.subscriptions),function(){a(r.channel,this)}),r.channel=null,n(r,r.channelStates.disconnected),t(null))})},channelStateChanged:function(t){t=e.createCallback(t);var n=this;return this._events.bind("onChannelStateChanged",function(e){t.call(n,e)})},subscribe:function(t,n){this._ensureConnectedState(),t=e.createCallback(t),n=n||{};var r=this.channel,i=new s(n.deviceIds,n.names,n.onMessage);return r.subscriptions.push(i),i._changeState(s.states.subscribing),r.subscribe(i,function(e,n){return e?(a(r,i),t(e)):(i._setId(n),i._changeState(s.states.subscribed),t(e,i))}),i},unsubscribe:function(t,n){this._ensureConnectedState(),n=e.createCallback(n);var r=this.channel;if(!t)throw new Error("Subscription must be defined. To unsubscribe from all subscriptions just close the channel");var o=t;return t instanceof s||(o=i(r,t))?o.state===s.states.unsubscribed?n(null):r.unsubscribe(o,function(e){return e?n(e):(a(r,o),n(e,o))}):n(e.errorMessage("Subscription with id "+t+" was not found"))},_ensureConnectedState:function(){if(this.channelState===this.channelStates.disconnected)throw new Error("DeviceHive: Channel is not opened, call the .openChannel() method first");if(this.channelState===this.channelStates.connecting)throw new Error("DeviceHive: Channel has not been initialized, use .openChannel().done() to run logic after the channel is initialized")}},u}(),s=function(){"use strict";var n=function(r,i,s){r&&!e.isArray(r)&&(r=[r]),i&&!e.isArray(i)&&(i=[i]),this.deviceIds=r||null,this.names=i||null,this.state=n.states.unsubscribed,this._events=new t,this.message(s)};return n.prototype.stateChanged=function(t){t=e.createCallback(t);var n=this;return this._events.bind("onStateChanged",function(e){t.call(n,e)})},n.prototype.message=function(t){return t=e.createCallback(t),this._events.bind("onMessage",t)},n.prototype._handleMessage=function(){this.state===n.states.subscribed&&this._events.trigger.apply(this._events,["onMessage"].concat(e.toArray(arguments)))},n.prototype._changeState=function(e){if(this.state===e)return!1;var t=this.state;this.state=e,this._events.trigger("onStateChanged",{oldState:t,newState:e})},n.prototype._setId=function(t){this.id=t||e.guid()},n.prototype.toJSON=function(){return{deviceIds:this.deviceIds,names:this.names,state:this.state}},n.states={unsubscribed:0,subscribing:1,subscribed:2},n}(),a=function(){"use strict";var t=function(t,n,r){e.forEach(n.deviceIds,function(){t.deviceIds[this]=r}),e.forEach(n.names,function(){t.names[this]=r})},n=function(e,n){!n.deviceIds&&++e.allDeviceIds,!n.names&&++e.allNames,t(e,n,!0)},r=function(e,n){!n.deviceIds&&--e.allDeviceIds,!n.names&&--e.allNames,t(e,n,!1)},i=function(t){var n=[];return e.forEach(t,function(e){t[e]&&n.push(e)}),n},s=function(e){return!e.allDeviceIds&&!e.allNames&&0===i(e.deviceIds).length&&0===i(e.names).length},a=function(t){return e.map(t,function(){return this.toLowerCase()})},u={open:function(t){t=e.createCallback(t),this._sub={deviceIds:{},allDeviceIds:0,names:{},allNames:0};var n=this._pollParams,r=this;return this._lp=new o(this._hive.serviceUrl,{executePoll:function(e,t){return e.deviceGuids=r._sub.allDeviceIds>0?null:i(r._sub.deviceIds),e.names=r._sub.allNames>0?null:i(r._sub.names),n.executePoll(e,t)},resolveTimestamp:n.resolveTimestamp,onData:function(t){var i=r.subscriptions,s=n.resolveName(t).toLowerCase(),o=n.resolveDeviceId(t).toLowerCase(),u=e.filter(i,function(){return(null===this.names||e.inArray(s,a(this.names))>-1)&&(null===this.deviceIds||e.inArray(o,a(this.deviceIds))>-1)});e.forEach(u,function(){var r=this;e.setTimeout(function(){r._handleMessage.apply(r,n.resolveDataArgs(t))},0)})}}),t(null)},close:function(t){return t=e.createCallback(t),this._lp.stopPolling(),t(null)},subscribe:function(t,r){return r=e.createCallback(r),this._lp.stopPolling(),n(this._sub,t),this._lp.startPolling(r)},unsubscribe:function(t,n){return n=e.createCallback(n),r(this._sub,t),this._lp.stopPolling(),s(this._sub)?n(null):this._lp.startPolling(n)}};return u}(),o=function(){"use strict";var t=function(n,r){var i={timestamp:r},s=function(i,s){if(i)n._polling&&!a.abortedManually&&e.setTimeout(function(){t(n,r)},1e3);else{var o=null;s&&e.forEach(s,function(){var e=n._poller.resolveTimestamp(this);(!o||e>o)&&(o=e),n._poller.onData(this)}),t(n,o||r)}},a=n._request=n._polling&&n._poller.executePoll(i,s)},n=function(e,t){this.serviceUrl=e,this._poller=t};return n.prototype={startPolling:function(n){n=e.createCallback(n),this._polling=!0;var i=this,s=this._request=r.info(this.serviceUrl,function(e,r){return e?n(s.abortedManually?null:e):(t(i,r.serverTimestamp),n(null))});return s},stopPolling:function(){this._polling=!1,this._request&&(this._request.abortedManually=!0,this._request.abort())}},n}(),u=function(){"use strict";var t=function(){this.WebSocket=this.WebSocket||window&&window.WebSocket};return t.requestTimeout=1e4,t.prototype={_handler:e.noop,open:function(t,n){n=e.createCallback(n);var r=this.WebSocket;if(!r)return n(e.errorMessage("WebSockets are not supported"));var i=this,s=!1;this._native=new r(t),this._native.onopen=function(e){s=!0,n(null,e)},this._native.onmessage=function(t){var n=JSON.parse(t.data);if(i._requests&&n.requestId){var r=i._requests[n.requestId];r&&(e.clearTimeout(r.timeout),n.status&&"success"==n.status?r.cb(null,n):r.cb({error:n.error}),delete i._requests[n.requestId])}else i._handler(n)},this._native.onclose=function(t){if(!s){var r=e.errorMessage("WebSocket connection has failed to open");return r.data=t,n(r)}}},close:function(t){t=e.createCallback(t),this._native.onclose=function(e){return t(null,e)},this._native.close()},message:function(e){this._handler=e},send:function(n,r,i){i=e.createCallback(i);var s=this,a={};return this._requestId=this._requestId||0,a.id=++this._requestId,a.cb=i,a.timeout=e.setTimeout(function(){a.cb(e.errorMessage("Operation timeout")),delete s._requests[a.id]},t.requestTimeout),this._requests=this._requests||{},this._requests[a.id]=a,r=r||{},r.requestId=a.id,r.action=n,this._native.send(JSON.stringify(r)),a}},t}(),c=function(){"use strict";var e=function(){var e=new t;this._events=e,this._transport=new u,this._transport.message(function(t){"command/insert"==t.action&&t.command&&t.command.id&&e.trigger("onCommandInsert",t),"command/update"==t.action&&e.trigger("onCommandUpdate",t),"notification/insert"==t.action&&t.deviceGuid&&t.notification&&e.trigger("onNotificationInsert",t)})};return e.prototype={open:function(e,t){this._transport.open(e+"/client",t)},close:function(e){this._transport.close(e)},getInfo:function(e){this._transport.send("server/info",null,e)},authenticate:function(e,t,n,r){this._transport.send("authenticate",{login:e,password:t,accessKey:n},r)},sendCommand:function(e,t){this._transport.send("command/insert",e,t)},updateCommand:function(e,t){this._transport.send("command/update",e,t)},commandSubscribe:function(e,t){this._transport.send("command/subscribe",e,t)},commandUnSubscribe:function(e,t){this._transport.send("command/unsubscribe",e,t)},sendNotification:function(e,t){this._transport.send("notification/insert",e,t)},notificationSubscribe:function(e,t){this._transport.send("notification/subscribe",e,t)},notificationUnSubscribe:function(e,t){this._transport.send("notification/unsubscribe",e,t)}},e}(),l=function(){"use strict";var t=function(e,t,n,i,s){return e._executeApi(r.waitCommandResult,[t,n,{waitTimeout:i},s])},n=function(e){this.subscriptions=[],this._hive=e;var t=this;this._pollParams={executePoll:function(e,n){return t._hive._executeApi(r.pollManyNotifications,[e,n])},resolveTimestamp:function(e){return e.notification.timestamp},resolveDataArgs:function(e){return[e.deviceGuid,e.notification]},resolveName:function(e){return e.notification.notification},resolveDeviceId:function(e){return e.deviceGuid}}};return n.prototype=a,n.constructor=n,n.prototype.sendCommand=function(n,i,s){function a(r,i){t(c._hive,n,r,u,function(t,n){return t=t||!n&&e.errorMessage("Cannot get command result. Wait request timed out."),t?i(t):i(null,n)})}function o(t,n){return(t=t||!n&&e.errorMessage("Error inserting a new command")||!n.id&&e.errorMessage("Cannot get inserted command id"))?s(t):(d=!0,f.command=n,s(null,n),void(h&&a(f.command.id,h)))}var u,c=this,l=i,h=e.noop(),d=!1,f={};return s=e.createCallback(s),this._hive._executeApi(r.insertCommand,[n,l,o]),f.result=function(e,t){if(t>60)throw new Error("Maximum wait timeout for longpolling channel = 60 seconds. Specified timeout - "+t);u=t,d?a(f.command.id,e):h=e},f},n}(),h=function(){"use strict";var n=function(e){this.subscriptions=[],this._hive=e,this._events=new t};return n.prototype={open:function(t){t=e.createCallback(t);var n=this._hive.serverInfo.webSocketServerUrl;if(!n)return void t(e.errorMessage("Open channel failed. Cannot get web socket server url"));var r=this;this._wsApi=new c,r._wsApi._events.bind("onCommandUpdate",function(t){var n=t.command,i=r._commandRequests[n.id];i&&(i._result=n,e.clearTimeout(i._timeout),i._onResult(null,n),delete r._commandRequests[n.id])}),r._wsApi._events.bind("onNotificationInsert",function(t){var n=e.find(r.subscriptions,function(){return this.id===t.subscriptionId});return n&&n._handleMessage(t.deviceGuid,t.notification)}),this._wsApi.open(n,function(e){return e?t(e):void r._wsApi.authenticate(r._hive.auth.login,r._hive.auth.password,r._hive.auth.accessKey,t)})},close:function(t){t=e.createCallback(t),this._wsApi.close(t)},subscribe:function(t,n){return n=e.createCallback(n),t?void this._wsApi.notificationSubscribe({deviceGuids:t.deviceIds,names:t.names},function(e,t){return n(e,t&&t.subscriptionId)}):n(null)},unsubscribe:function(t,n){n=e.createCallback(n),this._wsApi.notificationUnSubscribe({subscriptionId:t.id},n)},sendCommand:function(t,n,r){function i(t,n){return t?r(t,n):n&&n.command&&n.command.id?(s._commandRequests=s._commandRequests||{},s._commandRequests[n.command.id]=o,r(null,n),void(o.command=n.command)):r(e.errorMessage("Error inserting a new command"),n)}var s=this,a={deviceGuid:t,command:n},o={};return r=e.createCallback(r),this._wsApi.sendCommand(a,i),o._onResult=e.noop,o.result=function(t,n){return o._result?t(null,o._result):(o._onResult=t,void(o._timeout=e.setTimeout(function(){var t=o._onResult;o._onResult=e.noop,t(e.errorMessage("Cannot get command result. Wait request timed out."))},1e3*(n||30))))},o}},n}(),d=function(){"use strict";var t=function(e,t,n){this.serviceUrl=e,this.auth={},n?(this.auth.login=t,this.auth.password=n):this.auth.accessKey=t};return t.prototype=new i,t.constructor=t,t.prototype.getNetworks=function(t,n){return n=e.createCallback(n),this._executeApi(r.getNetworks,[t,n])},t.prototype.getNetwork=function(t,n){return n=e.createCallback(n),this._executeApi(r.getNetwork,[t,n])},t.prototype.getDevices=function(t,n){return n=e.createCallback(n),this._executeApi(r.getDevices,[t,n])},t.prototype.getDevice=function(t,n){return n=e.createCallback(n),this._executeApi(r.getDevice,[t,n])},t.prototype.getDeviceClass=function(t,n){if(n=e.createCallback(n),!this.auth.login)throw new Error("DeviceHive: DHClient should be created with username and password credentials to get device class information");return this._executeApi(r.getDeviceClass,[t,n])},t.prototype.getEquipmentState=function(t,n){return n=e.createCallback(n),this._executeApi(r.getEquipmentState,[t,n])},t.prototype.getNotifications=function(t,n,i){return i=e.createCallback(i),this._executeApi(r.getNotifications,[t,n,i])},t.prototype.getNotification=function(t,n,i){return i=e.createCallback(i),this._executeApi(r.getNotification,[t,n,i])},t.prototype.getCommands=function(t,n,i){return i=e.createCallback(i),this._executeApi(r.getCommands,[t,n,i])},t.prototype.getCommand=function(t,n,i){return i=e.createCallback(i),this._executeApi(r.getCommand,[t,n,i])},t.prototype.getCurrentUser=function(t){if(t=e.createCallback(t),!this.auth.login)throw new Error("DeviceHive: DHClient should be created with username and password credentials to get current user information");return this._executeApi(r.getCurrentUser,[t])},t.prototype.updateCurrentUser=function(t,n){if(n=e.createCallback(n),!this.auth.login)throw new Error("DeviceHive: DHClient should be created with username and password credentials to update current user");return this._executeApi(r.updateCurrentUser,[t,n])},t.prototype.sendCommand=function(t,n,r,i){return i=e.createCallback(i),this._ensureConnectedState(),this.channel.sendCommand(t,{command:n,parameters:r},i)},t.prototype._executeApi=function(e,t){var n=[this.serviceUrl,this.auth].concat(t);return e.apply(null,n)},t.prototype._channels={},t.prototype._channels.websocket=h,t.prototype._channels.longpolling=l,t.channelStates=t.prototype.channelStates,t.subscriptionStates=s.states,t}();return d});